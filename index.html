<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Siete Vidas Dulces - Dashboard Final</title>
    <style>
        :root { 
            --rojo-principal: #d32f2f; 
            --rojo-pastel: #ff8a80;    
            --rojo-oscuro: #9a0007;
            --fondo-crema: #fff5f2;    
            --blanco: #ffffff;
            --gris-texto: #4e342e;     
            --borde-suave: #f8bbd0;
            --azul-pago: #1976d2;
        }
        
        body { background: var(--fondo-crema); font-family: 'Segoe UI', sans-serif; margin: 0; padding: 20px; display: flex; justify-content: center; color: var(--gris-texto); }
        #app { display: flex; gap: 20px; max-width: 1450px; width: 100%; height: 95vh; }
        
        #tienda { flex: 2.5; background: var(--blanco); padding: 25px; border-radius: 25px; overflow-y: auto; box-shadow: 0 10px 30px rgba(0,0,0,0.05); border-top: 8px solid var(--rojo-principal); }
        .grid-dulces { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 15px; }
        
        .card { 
            background: #fff; border: 1px solid var(--borde-suave); padding: 15px; border-radius: 18px; 
            text-align: center; transition: 0.3s; display: flex; flex-direction: column; justify-content: space-between;
        }
        .card:hover { border-color: var(--rojo-principal); transform: translateY(-3px); }
        
        #panel { flex: 1; display: flex; flex-direction: column; gap: 20px; min-width: 320px; }
        .seccion { background: var(--blanco); padding: 20px; border-radius: 25px; border: 1px solid var(--borde-suave); }
        
        #chat-box { height: 280px; overflow-y: auto; background: #fffcfc; border-radius: 15px; padding: 10px; border: 1px solid var(--rojo-pastel); margin-bottom: 10px; font-size: 0.9em; }
        
        button { background: var(--rojo-pastel); color: white; border: none; padding: 10px; border-radius: 12px; cursor: pointer; font-weight: bold; width: 100%; transition: 0.3s; }
        button:hover { background: var(--rojo-principal); }
        
        .item-carrito { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px dotted var(--borde-suave); font-size: 0.8em; }
        .controles { display: flex; gap: 4px; }
        .btn-edit { width: 22px; height: 22px; padding: 0; border-radius: 5px; background: #eee; color: #333; }
        .btn-borrar { width: 22px; height: 22px; padding: 0; border-radius: 5px; background: #ffebee; color: #d32f2f; }

        /* Estilos de Pago */
        .metodos-pago-box { background: #f8f9fa; padding: 15px; border-radius: 15px; margin-top: 10px; border: 1px solid #ddd; }
        select { width: 100%; padding: 8px; border-radius: 10px; border: 1px solid #ccc; margin-bottom: 10px; }
        
        #ticket-final { 
            display: none; background: #e3f2fd; border: 2px dashed var(--azul-pago); 
            padding: 15px; border-radius: 15px; margin-top: 15px; text-align: center;
        }
    </style>
</head>
<body>
    <div id="app">
        <section id="tienda">
            <h2 style="text-align: center;">üêà‚Äç‚¨õ Siete Vidas Dulces üç¨</h2>
            <div class="grid-dulces" id="contenedor-grid"></div>
        </section>

        <div id="panel">
            <section class="seccion">
                <h3>üõçÔ∏è Mi Pedido</h3>
                <div id="lista-compras"></div>
                <p>Total: <b style="color: var(--rojo-principal);">$<span id="total-precio">0.00</span></b></p>
                
                <div class="metodos-pago-box">
                    <label style="font-size: 0.75em; font-weight: bold;">M√âTODO DE PAGO:</label>
                    <select id="metodo-pago">
                        <option value="TARJETA">üí≥ Tarjeta de Cr√©dito/D√©bito</option>
                        <option value="OXXO">üè™ Efectivo (OXXO/7-Eleven)</option>
                    </select>
                    <button onclick="iniciarProcesoPago()" style="background: var(--azul-pago);">Validar y Comprar</button>
                </div>

                <div id="ticket-final">
                    <b style="color: var(--azul-pago);">‚úì TRANSACCI√ìN EXITOSA</b><br>
                    <small id="metodo-usado"></small>
                    <div style="font-size: 1.1em; font-weight: bold; margin: 8px 0;" id="token-final"></div>
                    <small>Usa este token para recoger tu pedido.</small>
                </div>
            </section>

            <section class="seccion">
                <h3>üí¨ Ayudante üêà‚Äç‚¨õ</h3>
                <div id="chat-box"></div>
                <form id="chat-form" style="display:flex; gap:5px;">
                    <input type="text" id="user-input" placeholder="Pregunta algo..." required style="flex:1; padding:8px; border-radius:10px; border:1px solid #ddd;">
                    <button type="submit" style="width:50px;">üöÄ</button>
                </form>
            </section>
        </div>
    </div>

    <script>
        const API_URL = "https://api.groq.com/openai/v1/chat/completions";
        const API_KEY = "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";

        let carrito = [];

        const productos = [
            { n: "Mazap√°n De la Rosa", s: 6, b: 130 }, { n: "Pel√≥n Pelo Rico", s: 12, b: 110 },
            { n: "Pulparindo", s: 5, b: 85 }, { n: "Alegr√≠a Amaranto", s: 15, b: 140 },
            { n: "Borrachitos", s: 2, b: 45 }, { n: "Rockaleta", s: 8, b: 150 },
            { n: "Obleas con Cajeta", s: 18, b: 160 }, { n: "Palanqueta Nuez", s: 22, b: 200 },
            { n: "Cocada Blanca", s: 18, b: 170 }, { n: "Manzana Chamoy", s: 35, b: 300 },
            { n: "Ate de Membrillo", s: 40, b: 380 }, { n: "Puerquito de Pan", s: 12, b: 110 },
            { n: "Duval√≠n Bisabor", s: 7, b: 120 }, { n: "Chicles Canel's", s: 2, b: 90 },
            { n: "Pica Fresa", s: 1, b: 70 }, { n: "Skwinkles Rellenos", s: 14, b: 135 },
            { n: "Lucas Muecas", s: 15, b: 145 }, { n: "Glorias Linares", s: 12, b: 210 },
            { n: "Jamoncillo Leche", s: 25, b: 230 }, { n: "Camote Puebla", s: 20, b: 180 },
            { n: "Mu√©gano Tradicional", s: 10, b: 95 }, { n: "Lim√≥n con Coco", s: 15, b: 140 },
            { n: "Chocomelvavisco", s: 10, b: 180 }, { n: "Barra Chocolate", s: 22, b: 350 },
            { n: "Vaso de Cajeta", s: 8, b: 150 }, { n: "Piruleta Rayada", s: 6, b: 110 },
            { n: "Galleta Sol", s: 5, b: 90 }, { n: "Morelianas", s: 15, b: 140 },
            { n: "Tama-Roca", s: 10, b: 95 }, { n: "Bandera de Coco", s: 15, b: 140 }
        ];

        const grid = document.getElementById("contenedor-grid");
        productos.forEach((p, i) => {
            grid.innerHTML += `
                <div class="card">
                    <span>${p.n}</span>
                    <b>Pz: $${p.s} | Bol: $${p.b}</b>
                    <select id="modo-${i}"><option value="Pz">Suelto</option><option value="Bol">Bolsa</option></select>
                    <input type="number" id="cant-${i}" value="1" min="1" style="width: 50px; margin: 0 auto 10px;">
                    <button onclick="agregar(${i})">üõí Agregar</button>
                </div>`;
        });

        function agregar(idx) {
            const p = productos[idx];
            const modo = document.getElementById(`modo-${idx}`).value;
            const cant = parseInt(document.getElementById(`cant-${idx}`).value);
            const precio = modo === "Bol" ? p.b : p.s;
            const existente = carrito.find(item => item.n === p.n && item.t === modo);
            if (existente) existente.c += cant;
            else carrito.push({ n: p.n, c: cant, p: precio, t: modo });
            renderCarrito();
        }

        function cambiarCant(index, delta) {
            carrito[index].c += delta;
            if (carrito[index].c <= 0) carrito.splice(index, 1);
            renderCarrito();
        }

        function borrarItem(index) {
            carrito.splice(index, 1);
            renderCarrito();
        }

        function renderCarrito() {
            const lista = document.getElementById("lista-compras");
            let total = 0;
            lista.innerHTML = "";
            carrito.forEach((item, i) => {
                total += item.p * item.c;
                lista.innerHTML += `
                    <div class="item-carrito">
                        <div style="flex:1;"><b>${item.c}x</b> ${item.n}</div>
                        <div class="controles">
                            <button class="btn-edit" onclick="cambiarCant(${i}, 1)">+</button>
                            <button class="btn-edit" onclick="cambiarCant(${i}, -1)">-</button>
                            <button class="btn-borrar" onclick="borrarItem(${i})">‚úï</button>
                        </div>
                    </div>`;
            });
            document.getElementById("total-precio").innerText = total.toFixed(2);
        }

        // --- L√ìGICA DE PAGO Y VERIFICACI√ìN ---
        function iniciarProcesoPago() {
            if (carrito.length === 0) return alert("¬°El carrito est√° vac√≠o, carnal!");

            const metodo = document.getElementById("metodo-pago").value;
            // Token de verificaci√≥n simulado (OTP)
            const otpEnviado = Math.floor(1000 + Math.random() * 9000);
            alert(`üîê VERIFICACI√ìN DE SEGURIDAD\n\nTu c√≥digo de autorizaci√≥n es: ${otpEnviado}`);

            const otpUsuario = prompt("Ingresa el c√≥digo de 4 d√≠gitos enviado a tu dispositivo:");

            if (otpUsuario == otpEnviado) {
                confirmarVenta(metodo);
            } else {
                alert("‚ùå Token de verificaci√≥n incorrecto. Int√©ntalo de nuevo.");
            }
        }

        function confirmarVenta(metodo) {
            const prefijo = metodo === "TARJETA" ? "TC" : "OX";
            const tokenFinal = `${prefijo}-${Math.random().toString(36).substr(2, 6).toUpperCase()}-SV`;

            document.getElementById("metodo-usado").innerText = `Pagado con: ${metodo}`;
            document.getElementById("token-final").innerText = tokenFinal;
            document.getElementById("ticket-final").style.display = "block";
            
            alert(`‚úÖ Pago verificado. Tu folio es: ${tokenFinal}`);
            carrito = [];
            renderCarrito();
        }

        // --- CHAT IA ---
        document.getElementById("chat-form").addEventListener("submit", async (e) => {
            e.preventDefault();
            const input = document.getElementById("user-input");
            const box = document.getElementById("chat-box");
            const msg = input.value;
            box.innerHTML += `<p><b>T√∫:</b> ${msg}</p>`;
            input.value = "";

            try {
                const res = await fetch(API_URL, {
                    method: "POST",
                    headers: { "Content-Type": "application/json", "Authorization": "Bearer " + API_KEY },
                    body: JSON.stringify({
                        model: "llama-3.3-70b-versatile",
                        messages: [{ 
                            role: "system", 
                            content: `Eres el Ayudante de "Siete Vidas Dulces". Ayuda con precios y existencias. Actitud mexicana, amable y usa emojis de gato üêà‚Äç‚¨õ.` 
                        }, { role: "user", content: msg }]
                    })
                });
                const data = await res.json();
                box.innerHTML += `<p style="color:var(--rojo-oscuro)"><b>Ayudante üêà‚Äç‚¨õ:</b> ${data.choices[0].message.content}</p>`;
                box.scrollTop = box.scrollHeight;
            } catch (e) { box.innerHTML += "<p>Ayudante fuera de l√≠nea...</p>"; }
        });
    </script>
</body>
</html>